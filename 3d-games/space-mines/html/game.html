<!DOCTYPE html>

<html>

<head>
    <title>Example 01.04 - Materials, light and animation</title>
    <script type="text/javascript" src="../libs/three.js"></script>
    <script type="text/javascript" src="../libs/stats.js"></script>
    <script type="text/javascript" src="../libs/FlyControls.js"></script>
    <script type="text/javascript" src="../libs/Projector.js"></script>
    <style>
        body {
            /* set margin to 0 and overflow to hidden, to go fullscreen */
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>

<div id="Stats-output">
</div>
<!-- Div which will hold the Output -->
<div id="WebGL-output">
</div>

<!-- Javascript code that runs our Three.js examples -->
<script type="text/javascript">

    var selectedObject;
    var projector = new THREE.Projector();
    var offset = new THREE.Vector3();
    var objects = [];

    function randomLocation(dimension) {
        var x = Math.floor(Math.random() * dimension);
        var y = Math.floor(Math.random() * dimension);
        var z = Math.floor(Math.random() * dimension);
        return {x: x, y: y, z: z};
    }

    var MineSphere = function() {
        // Run the Mesh constructor with the given arguments
        THREE.Mesh.apply(this, arguments);

        this.material.transparent = true;
        this.material.opacity = 0.9;
        this.bombCount = 0;
        this.hasMine = false;
        this.material.color(0x8888);

        this.setPosition = function(x, y, z) {
            this.x = x;
            this.y = y;
            this.z = z;
            this.position.set((this.x - 2) * 250, (this.y - 1) * 250, (this.z - 3) * 250);
        };

        this.incrementMineCount = function() {
            this.bombCount++;
        };

        this.toString = function() {
            return "x=" + this.x + ", y=" + this.y + ", z=" + this.z + ", hasMine=" + this.hasMine;
        };
    };

    // Make MyObject3D have the same methods as Mesh
    MineSphere.prototype = Object.create(THREE.Mesh.prototype);
    // Make sure the right constructor gets called
    MineSphere.prototype.constructor = MineSphere;

    // once everything is loaded, we run our Three.js stuff.
    function init() {

        var scene = new THREE.Scene();

        // This is what sees the stuff:
        var aspect_ratio = window.innerWidth / window.innerHeight;
        var camera = new THREE.PerspectiveCamera(75, aspect_ratio, 1, 10000);
        camera.position.z = 500;
        scene.add(camera);

        // This will draw what the camera sees onto the screen:
        var renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        var flyControls = new THREE.FlyControls(camera);

        flyControls.movementSpeed = 200;
        flyControls.domElement = document.querySelector("#WebGL-output");
        flyControls.rollSpeed = Math.PI / 24;
        flyControls.autoForward = false;
        flyControls.dragToLook = true;

        document.getElementById("WebGL-output").appendChild(renderer.domElement);

        document.onmousedown = function(event) {
            var mouseX = (event.clientX / window.innerWidth) * 2 - 1;
            var mouseY = (event.clientY / window.innerHeight) * 2 - 1;
            var vector = new THREE.Vector3(mouseX, mouseY, 0.5);
            vector.unproject(camera);
            var raycaster = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());
            var intersects = raycaster.intersectObjects(objects);

            for (var i = 0; i < intersects.length; i++) {
                selectedObject = intersects[0].object;
                if(selectedObject.isBomb || selectedObject.isDud()) {
                    bombClicked(selectedObject);
                    break;
                }
            }
        };


        var clock = new THREE.Clock();

        render();

        function render() {
            var delta = clock.getDelta();
            flyControls.update(delta);
            renderer.clear();
            // render using requestAnimationFrame
            requestAnimationFrame(render);
            renderer.render(scene, camera);
        }
    }
    window.onload = init;

</script>
</body>
</html>